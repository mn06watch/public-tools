<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bills Sponsored | MN-06 Watch</title>
    <meta name="description" content="Track Rep. Tom Emmer's sponsored and cosponsored legislation. See which bills became law and which died in committee.">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        :root {
            --navy: #1e3a5f;
            --navy-dark: #152a45;
            --navy-light: #2a4a73;
            --gold: #d4a84b;
            --gold-light: #e4bc6b;
            --gold-dark: #b8923f;
            --bg-dark: #0d1117;
            --bg-card: #151c25;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --border: #2a3441;
            --green: #238636;
            --green-light: #2ea043;
            --red: #da3633;
            --red-light: #f85149;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        header {
            text-align: center;
            padding: 40px 0 30px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 30px;
        }
        
        .page-title { font-size: 2.5rem; font-weight: 800; color: #fff; margin-bottom: 8px; }
        .page-title span { color: var(--gold); }
        .page-subtitle { color: var(--text-secondary); font-size: 1.1rem; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid var(--border);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .stat-card:hover { border-color: var(--navy-light); transform: translateY(-2px); }
        .stat-card.active { border-color: var(--gold); background: rgba(212, 168, 75, 0.1); }
        
        .stat-value { font-size: 2.2rem; font-weight: 700; color: var(--gold); line-height: 1; }
        .stat-value.success { color: var(--green-light); }
        .stat-value.failure { color: var(--red-light); }
        .stat-label { font-size: 0.85rem; color: var(--text-secondary); margin-top: 8px; }
        
        .highlight-box {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-dark) 100%);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid var(--navy-light);
        }
        
        .highlight-box h3 { color: var(--gold); margin-bottom: 15px; font-size: 1.2rem; }
        .highlight-box p { color: var(--text-secondary); margin-bottom: 10px; }
        .highlight-box .big-stat { font-size: 3rem; font-weight: 700; color: var(--red-light); }
        
        .filter-bar {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            background: var(--bg-dark);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
        }
        
        .search-input::placeholder { color: var(--text-secondary); }
        .search-input:focus { outline: none; border-color: var(--gold); }
        
        .filter-select {
            padding: 10px 12px;
            background: var(--bg-dark);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .filter-label { color: var(--text-secondary); font-size: 0.9rem; }
        
        .clear-filters-btn {
            padding: 10px 15px;
            background: var(--navy);
            color: var(--gold);
            border: 1px solid var(--navy-light);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .clear-filters-btn:hover { background: var(--navy-light); }
        .results-count { color: var(--text-secondary); font-size: 0.9rem; margin-left: auto; }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
        }
        
        .chart-title { font-size: 1.1rem; font-weight: 600; color: #fff; margin-bottom: 15px; }
        .chart-container { position: relative; height: 300px; }
        
        .repeat-bills-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }
        
        .repeat-bills-section h3 { color: var(--gold); margin-bottom: 15px; font-size: 1.1rem; }
        
        .repeat-bill-item { padding: 12px 0; border-bottom: 1px solid var(--border); }
        .repeat-bill-item:last-child { border-bottom: none; }
        .repeat-bill-title { color: var(--text-primary); font-weight: 500; margin-bottom: 5px; }
        .repeat-bill-meta { font-size: 0.85rem; color: var(--text-secondary); }
        .repeat-count { background: var(--red); color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; margin-left: 8px; }
        
        .bill-card {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            transition: border-color 0.2s;
        }
        
        .bill-card:hover { border-color: var(--navy-light); }
        
        .bill-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 15px; margin-bottom: 10px; }
        .bill-number { font-weight: 700; color: var(--gold); font-size: 1rem; }
        
        .bill-status { padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; white-space: nowrap; }
        .bill-status.law { background: rgba(46, 160, 67, 0.2); color: var(--green-light); border: 1px solid var(--green); }
        .bill-status.died { background: rgba(248, 81, 73, 0.2); color: var(--red-light); border: 1px solid var(--red); }
        .bill-status.committee { background: rgba(139, 148, 158, 0.2); color: var(--text-secondary); border: 1px solid var(--border); }
        .bill-status.passed { background: rgba(212, 168, 75, 0.2); color: var(--gold); border: 1px solid var(--gold-dark); }
        
        .bill-title { color: var(--text-primary); font-size: 0.95rem; line-height: 1.4; margin-bottom: 10px; }
        .bill-meta { display: flex; gap: 15px; flex-wrap: wrap; font-size: 0.85rem; color: var(--text-secondary); }
        .bill-link { color: var(--gold); text-decoration: none; font-size: 0.85rem; }
        .bill-link:hover { text-decoration: underline; }
        .policy-tag { display: inline-block; padding: 3px 10px; background: var(--navy-dark); color: var(--text-secondary); border-radius: 10px; font-size: 0.75rem; margin-top: 8px; }
        
        .load-more {
            display: block;
            width: 100%;
            padding: 15px;
            background: var(--navy);
            color: #fff;
            border: 1px solid var(--navy-light);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
            margin-top: 20px;
        }
        
        .load-more:hover { background: var(--navy-light); }
        .no-results { text-align: center; padding: 40px; color: var(--text-secondary); }
        
        footer {
            text-align: center;
            padding: 40px 20px;
            border-top: 1px solid var(--border);
            margin-top: 40px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        footer a { color: var(--gold); text-decoration: none; }
        footer a:hover { text-decoration: underline; }
        
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .charts-grid { grid-template-columns: 1fr; }
            .filter-bar { flex-direction: column; align-items: stretch; }
            .results-count { margin-left: 0; text-align: center; }
        }
    </style>
</head>
<body>
    <div id="mn06-nav"></div>
    
    <div class="container">
        <header>
            <h1 class="page-title">Bills <span>Sponsored</span></h1>
            <p class="page-subtitle">Tracking Rep. Emmer's legislative record since 2015</p>
        </header>
        
        <!-- Clickable Stats -->
        <div class="stats-grid">
            <div class="stat-card" onclick="filterByCard('sponsored')" id="card-sponsored">
                <div class="stat-value" id="total-sponsored">--</div>
                <div class="stat-label">Bills Sponsored</div>
            </div>
            <div class="stat-card" onclick="filterByCard('law')" id="card-law">
                <div class="stat-value success" id="became-law">--</div>
                <div class="stat-label">Became Law</div>
            </div>
            <div class="stat-card" onclick="filterByCard('died')" id="card-died">
                <div class="stat-value failure" id="died-committee">--</div>
                <div class="stat-label">Died in Committee</div>
            </div>
            <div class="stat-card" onclick="filterByCard('rate')" id="card-rate">
                <div class="stat-value" id="success-rate">--</div>
                <div class="stat-label">Success Rate</div>
            </div>
            <div class="stat-card" onclick="filterByCard('cosponsored')" id="card-cosponsored">
                <div class="stat-value" id="total-cosponsored">--</div>
                <div class="stat-label">Cosponsored</div>
            </div>
        </div>
        
        <!-- Dynamic Insight Box -->
        <div class="highlight-box">
            <h3 id="insight-title">üìä The Bottom Line</h3>
            <div id="insight-content"><p>Loading...</p></div>
        </div>
        
        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-title">üìÇ Policy Areas (Sponsored Bills)</div>
                <div class="chart-container"><canvas id="policy-chart"></canvas></div>
            </div>
            <div class="chart-card">
                <div class="chart-title">üìà Bills by Congress</div>
                <div class="chart-container"><canvas id="congress-chart"></canvas></div>
            </div>
        </div>
        
        <!-- Repeat Bills -->
        <div class="repeat-bills-section" id="repeat-bills-section">
            <h3>üîÑ Repeat Bills (Introduced Multiple Times, Never Passed)</h3>
            <div id="repeat-bills-list">Loading...</div>
        </div>
        
        <!-- Search and Filters -->
        <div class="filter-bar">
            <input type="text" class="search-input" id="search-input" placeholder="Search bills by title or keyword..." oninput="applyFilters()">
            <span class="filter-label">Congress:</span>
            <select class="filter-select" id="congress-filter" onchange="applyFilters()">
                <option value="">All</option>
                <option value="119">119th (2025-27)</option>
                <option value="118">118th (2023-25)</option>
                <option value="117">117th (2021-23)</option>
                <option value="116">116th (2019-21)</option>
                <option value="115">115th (2017-19)</option>
                <option value="114">114th (2015-17)</option>
            </select>
            <span class="filter-label">Policy:</span>
            <select class="filter-select" id="policy-filter" onchange="applyFilters()">
                <option value="">All Areas</option>
            </select>
            <button class="clear-filters-btn" onclick="clearFilters()">Clear Filters</button>
            <span class="results-count" id="results-count">-- bills</span>
        </div>
        
        <!-- Bills List -->
        <div id="bills-container"><p class="no-results">Loading...</p></div>
        <button class="load-more" id="load-more-btn" onclick="loadMore()" style="display: none;">Load More Bills</button>
        
        <footer>
            <p>Data from <a href="https://congress.gov" target="_blank">Congress.gov</a>. Updated <span id="last-updated">--</span>.</p>
            <p style="margin-top: 8px;"><a href="/">Vote Tracker</a> ¬∑ <a href="/transcripts/">Transcripts</a> ¬∑ <a href="https://mn06watch.substack.com">Newsletter</a></p>
            <p style="margin-top: 10px;">¬© 2025 MN-06 Watch. Independent accountability journalism.</p>
        </footer>
    </div>
    
    <script src="/nav.js"></script>
    <script>
        let allBills = [];
        let filteredBills = [];
        let activeCard = null;
        let displayCount = 25;
        let charts = {};
        
        async function loadData() {
            try {
                const response = await fetch('https://pub-19f43b48149546699964c5a800800a2f.r2.dev/sponsorships_data.json');
                const data = await response.json();
                allBills = data.bills || [];
                
                updateStats();
                populatePolicyFilter();
                createCharts();
                findRepeatBills();
                applyFilters();
                
                if (data.last_updated) {
                    const date = new Date(data.last_updated);
                    document.getElementById('last-updated').textContent = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                }
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('bills-container').innerHTML = '<p class="no-results">Error loading data.</p>';
            }
        }
        
        function updateStats() {
            const allSponsored = allBills.filter(b => b.role === 'sponsor');
            const allCosponsored = allBills.filter(b => b.role === 'cosponsor');
            
            // Always show totals for sponsored and cosponsored
            document.getElementById('total-sponsored').textContent = allSponsored.length;
            document.getElementById('total-cosponsored').textContent = allCosponsored.length.toLocaleString();
            
            // Dynamic stats based on active card
            updateDynamicStats();
        }
        
        function updateDynamicStats() {
            let baseBills;
            if (activeCard === 'cosponsored') {
                baseBills = allBills.filter(b => b.role === 'cosponsor');
            } else {
                baseBills = allBills.filter(b => b.role === 'sponsor');
            }
            
            const laws = baseBills.filter(b => b.status === 'Became Law');
            const died = baseBills.filter(b => b.died_in_committee);
            const rate = baseBills.length > 0 ? (laws.length / baseBills.length * 100).toFixed(1) + '%' : '0%';
            
            document.getElementById('became-law').textContent = laws.length;
            document.getElementById('died-committee').textContent = died.length;
            document.getElementById('success-rate').textContent = rate;
        }
        
        function updateInsights() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const congressFilter = document.getElementById('congress-filter').value;
            const policyFilter = document.getElementById('policy-filter').value;
            
            const titleEl = document.getElementById('insight-title');
            const contentEl = document.getElementById('insight-content');
            
            let title = 'üìä The Bottom Line';
            let html = '';
            
            // Search active
            if (searchTerm) {
                title = `üîç "${searchTerm}" Bills`;
                const matchSponsored = allBills.filter(b => b.role === 'sponsor' && ((b.title && b.title.toLowerCase().includes(searchTerm)) || (b.policy_area && b.policy_area.toLowerCase().includes(searchTerm))));
                const matchCosponsored = allBills.filter(b => b.role === 'cosponsor' && ((b.title && b.title.toLowerCase().includes(searchTerm)) || (b.policy_area && b.policy_area.toLowerCase().includes(searchTerm))));
                const matchLaws = matchSponsored.filter(b => b.status === 'Became Law');
                const matchDied = matchSponsored.filter(b => b.died_in_committee);
                
                if (matchSponsored.length === 0) {
                    html = `<p>Emmer hasn't sponsored any bills matching "${searchTerm}".</p>`;
                    if (matchCosponsored.length > 0) {
                        html += `<p style="margin-top: 10px;">He has <strong>cosponsored ${matchCosponsored.length}</strong> bills on this topic.</p>`;
                    }
                } else if (matchLaws.length > 0) {
                    html = `<p>Emmer sponsored <strong>${matchSponsored.length}</strong> bills on "${searchTerm}".</p>`;
                    html += `<p><span class="big-stat" style="color: var(--green-light);">${matchLaws.length}</span> became law! üéâ</p>`;
                } else {
                    html = `<p>Emmer sponsored <strong>${matchSponsored.length}</strong> bills on "${searchTerm}".</p>`;
                    html += `<p><span class="big-stat">${matchDied.length}</span> died in committee.</p>`;
                    html += `<p style="margin-top: 10px; font-size: 0.9rem;">Success rate: <strong>0%</strong></p>`;
                }
            }
            // Policy filter
            else if (policyFilter) {
                title = `üìÇ ${policyFilter}`;
                const policySponsored = allBills.filter(b => b.role === 'sponsor' && (b.policy_area || 'Uncategorized') === policyFilter);
                const policyLaws = policySponsored.filter(b => b.status === 'Became Law');
                const policyDied = policySponsored.filter(b => b.died_in_committee);
                const policyRate = policySponsored.length > 0 ? ((policyLaws.length / policySponsored.length) * 100).toFixed(0) : 0;
                
                html = `<p>Emmer sponsored <strong>${policySponsored.length}</strong> ${policyFilter} bills.</p>`;
                html += `<p><span class="big-stat">${policyDied.length}</span> died in committee.</p>`;
                html += `<p style="margin-top: 10px; font-size: 0.9rem;">Success rate: <strong>${policyRate}%</strong>`;
                if (policyLaws.length === 0 && policySponsored.length > 5) {
                    html += ` ‚Äî Despite ${policySponsored.length} attempts, zero became law.`;
                }
                html += `</p>`;
            }
            // Congress filter
            else if (congressFilter) {
                const congressNum = parseInt(congressFilter);
                const yearStart = 2015 + (congressNum - 114) * 2;
                title = `üèõÔ∏è ${congressNum}th Congress (${yearStart}-${yearStart + 2})`;
                
                const cSponsored = allBills.filter(b => b.role === 'sponsor' && b.congress == congressFilter);
                const cLaws = cSponsored.filter(b => b.status === 'Became Law');
                const cDied = cSponsored.filter(b => b.died_in_committee);
                const avgPerCongress = allBills.filter(b => b.role === 'sponsor').length / 6;
                
                html = `<p>Sponsored <strong>${cSponsored.length}</strong> bills (${cSponsored.length > avgPerCongress ? 'above' : 'below'} his average of ${avgPerCongress.toFixed(0)}).</p>`;
                html += `<p><span class="big-stat">${cDied.length}</span> died in committee.</p>`;
                html += cLaws.length > 0 
                    ? `<p style="margin-top: 10px; font-size: 0.9rem;"><strong>${cLaws.length}</strong> became law! üéâ</p>`
                    : `<p style="margin-top: 10px; font-size: 0.9rem;">None became law.</p>`;
            }
            // Cosponsored card
            else if (activeCard === 'cosponsored') {
                title = 'ü§ù Cosponsored Bills';
                const coTotal = allBills.filter(b => b.role === 'cosponsor').length;
                const coLaws = allBills.filter(b => b.role === 'cosponsor' && b.status === 'Became Law').length;
                const coDied = allBills.filter(b => b.role === 'cosponsor' && b.died_in_committee).length;
                html = `<p>Emmer put his name on <strong>${coTotal.toLocaleString()}</strong> other members' bills.</p>`;
                html += `<p style="margin-top: 10px;"><strong>${coLaws}</strong> became law, <strong>${coDied}</strong> died in committee.</p>`;
                html += `<p style="margin-top: 10px; font-size: 0.9rem;">Cosponsoring is easy ‚Äî just a signature showing support. Sponsored bills show what he actually prioritizes.</p>`;
            }
            // Law card
            else if (activeCard === 'law') {
                title = '‚úÖ Bills That Became Law';
                const lawBills = allBills.filter(b => b.role === 'sponsor' && b.status === 'Became Law');
                const postOffice = lawBills.filter(b => b.title && b.title.toLowerCase().includes('postal'));
                
                html = `<p>In 10 years, <strong>${lawBills.length}</strong> of Emmer's bills became law.</p>`;
                if (postOffice.length > 0) {
                    html += `<p style="margin-top: 10px;"><span class="big-stat" style="color: var(--gold);">${postOffice.length}</span> were post office namings.</p>`;
                    if (lawBills.length - postOffice.length > 0) {
                        html += `<p style="font-size: 0.9rem;">${lawBills.length - postOffice.length} other bill${lawBills.length - postOffice.length > 1 ? 's' : ''} passed.</p>`;
                    }
                }
            }
            // Died card
            else if (activeCard === 'died') {
                title = '‚ö∞Ô∏è Died in Committee';
                const diedBills = allBills.filter(b => b.role === 'sponsor' && b.died_in_committee);
                const totalSponsored = allBills.filter(b => b.role === 'sponsor').length;
                const diedPct = Math.round((diedBills.length / totalSponsored) * 100);
                
                html = `<p><span class="big-stat">${diedPct}%</span> of Emmer's sponsored bills died in committee.</p>`;
                html += `<p style="margin-top: 10px;">That's <strong>${diedBills.length}</strong> bills that never got a floor vote.</p>`;
                html += `<p style="margin-top: 10px; font-size: 0.9rem;">Even with Republicans controlling the House, his bills don't advance.</p>`;
            }
            // Default
            else {
                const totalSponsored = allBills.filter(b => b.role === 'sponsor').length;
                const totalLaws = allBills.filter(b => b.role === 'sponsor' && b.status === 'Became Law').length;
                const totalDied = allBills.filter(b => b.role === 'sponsor' && b.died_in_committee).length;
                const postOffice = allBills.filter(b => b.role === 'sponsor' && b.status === 'Became Law' && b.title && b.title.toLowerCase().includes('postal')).length;
                
                html = `<p>In <strong>10 years</strong> in Congress, Rep. Emmer has sponsored <strong>${totalSponsored}</strong> bills.</p>`;
                html += `<p>Of those, <span class="big-stat">${totalDied}</span> died in committee without ever receiving a vote.</p>`;
                html += `<p style="margin-top: 15px; font-size: 0.9rem;">His <strong>${totalLaws}</strong> bills that became law include `;
                html += postOffice === totalLaws ? `post office namings.</p>` : postOffice > 0 ? `${postOffice} post office naming${postOffice > 1 ? 's' : ''} and ${totalLaws - postOffice} other.</p>` : `various legislation.</p>`;
            }
            
            titleEl.textContent = title;
            contentEl.innerHTML = html;
        }
        
        function populatePolicyFilter() {
            const policies = {};
            allBills.filter(b => b.role === 'sponsor').forEach(b => {
                const area = b.policy_area || 'Uncategorized';
                policies[area] = (policies[area] || 0) + 1;
            });
            
            const select = document.getElementById('policy-filter');
            Object.entries(policies).sort((a, b) => b[1] - a[1]).forEach(([area, count]) => {
                const option = document.createElement('option');
                option.value = area;
                option.textContent = `${area} (${count})`;
                select.appendChild(option);
            });
        }
        
        function createCharts() {
            createPolicyChart();
            createCongressChart();
        }
        
        function createPolicyChart() {
            const ctx = document.getElementById('policy-chart');
            const sponsored = allBills.filter(b => b.role === 'sponsor');
            
            const policyData = {};
            sponsored.forEach(b => {
                const area = b.policy_area || 'Uncategorized';
                if (!policyData[area]) policyData[area] = { total: 0, laws: 0, died: 0 };
                policyData[area].total++;
                if (b.status === 'Became Law') policyData[area].laws++;
                if (b.died_in_committee) policyData[area].died++;
            });
            
            const sorted = Object.entries(policyData).sort((a, b) => b[1].total - a[1].total).slice(0, 10);
            
            charts.policy = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(([area]) => area.length > 20 ? area.substring(0, 20) + '...' : area),
                    datasets: [
                        { label: 'Died', data: sorted.map(([_, d]) => d.died), backgroundColor: 'rgba(248, 81, 73, 0.7)', borderColor: '#da3633', borderWidth: 1 },
                        { label: 'Other', data: sorted.map(([_, d]) => d.total - d.died - d.laws), backgroundColor: 'rgba(139, 148, 158, 0.7)', borderColor: '#8b949e', borderWidth: 1 },
                        { label: 'Law', data: sorted.map(([_, d]) => d.laws), backgroundColor: 'rgba(46, 160, 67, 0.7)', borderColor: '#238636', borderWidth: 1 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                    scales: {
                        x: { stacked: true, ticks: { color: '#8b949e' }, grid: { color: '#2a3441' } },
                        y: { stacked: true, ticks: { color: '#e6edf3', font: { size: 11 } }, grid: { display: false } }
                    },
                    plugins: { legend: { position: 'bottom', labels: { color: '#e6edf3', boxWidth: 12 } } },
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            document.getElementById('policy-filter').value = sorted[elements[0].index][0];
                            applyFilters();
                        }
                    }
                }
            });
        }
        
        function createCongressChart() {
            const ctx = document.getElementById('congress-chart');
            const sponsored = allBills.filter(b => b.role === 'sponsor');
            
            const congressData = {};
            sponsored.forEach(b => {
                const c = b.congress || 'Unknown';
                if (!congressData[c]) congressData[c] = { total: 0, laws: 0, died: 0 };
                congressData[c].total++;
                if (b.status === 'Became Law') congressData[c].laws++;
                if (b.died_in_committee) congressData[c].died++;
            });
            
            const congresses = [114, 115, 116, 117, 118, 119].filter(c => congressData[c]);
            
            charts.congress = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: congresses.map(c => `${c}th`),
                    datasets: [
                        { label: 'Died', data: congresses.map(c => congressData[c]?.died || 0), backgroundColor: 'rgba(248, 81, 73, 0.7)', borderColor: '#da3633', borderWidth: 1 },
                        { label: 'Other', data: congresses.map(c => (congressData[c]?.total || 0) - (congressData[c]?.died || 0) - (congressData[c]?.laws || 0)), backgroundColor: 'rgba(139, 148, 158, 0.7)', borderColor: '#8b949e', borderWidth: 1 },
                        { label: 'Law', data: congresses.map(c => congressData[c]?.laws || 0), backgroundColor: 'rgba(46, 160, 67, 0.7)', borderColor: '#238636', borderWidth: 1 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true, ticks: { color: '#e6edf3' }, grid: { color: '#2a3441' } },
                        y: { stacked: true, ticks: { color: '#8b949e' }, grid: { color: '#2a3441' } }
                    },
                    plugins: { legend: { position: 'bottom', labels: { color: '#e6edf3', boxWidth: 12 } } },
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            document.getElementById('congress-filter').value = congresses[elements[0].index];
                            applyFilters();
                        }
                    }
                }
            });
        }
        
        function findRepeatBills() {
            const sponsored = allBills.filter(b => b.role === 'sponsor');
            const titleGroups = {};
            
            sponsored.forEach(b => {
                let key = (b.title || '').toLowerCase().replace(/of \d{4}/, '').replace(/\s+/g, ' ').trim().substring(0, 80);
                if (key.length < 10) return;
                if (!titleGroups[key]) titleGroups[key] = [];
                titleGroups[key].push(b);
            });
            
            const repeats = Object.entries(titleGroups)
                .filter(([_, bills]) => bills.length > 1 && !bills.some(b => b.status === 'Became Law'))
                .sort((a, b) => b[1].length - a[1].length)
                .slice(0, 5);
            
            const container = document.getElementById('repeat-bills-list');
            if (repeats.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No repeat failed bills found.</p>';
                return;
            }
            
            container.innerHTML = repeats.map(([_, bills]) => {
                const congresses = bills.map(b => b.congress).sort().join(', ');
                const title = bills[0].title || 'Untitled';
                return `<div class="repeat-bill-item">
                    <div class="repeat-bill-title">${title.length > 80 ? title.substring(0, 80) + '...' : title}<span class="repeat-count">${bills.length}x introduced</span></div>
                    <div class="repeat-bill-meta">Congresses: ${congresses}th ¬∑ All died in committee</div>
                </div>`;
            }).join('');
        }
        
        function filterByCard(type) {
            document.getElementById('search-input').value = '';
            document.getElementById('congress-filter').value = '';
            document.getElementById('policy-filter').value = '';
            document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
            
            if (activeCard === type) {
                activeCard = null;
            } else {
                activeCard = type;
                document.getElementById(`card-${type}`).classList.add('active');
            }
            
            updateDynamicStats();
            applyFilters();
        }
        
        function applyFilters() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const congressFilter = document.getElementById('congress-filter').value;
            const policyFilter = document.getElementById('policy-filter').value;
            
            let bills = allBills;
            
            // Card filter
            if (activeCard === 'sponsored') bills = bills.filter(b => b.role === 'sponsor');
            else if (activeCard === 'cosponsored') bills = bills.filter(b => b.role === 'cosponsor');
            else if (activeCard === 'law') bills = bills.filter(b => b.role === 'sponsor' && b.status === 'Became Law');
            else if (activeCard === 'died') bills = bills.filter(b => b.role === 'sponsor' && b.died_in_committee);
            else if (activeCard === 'rate') bills = bills.filter(b => b.role === 'sponsor');
            else bills = bills.filter(b => b.role === 'sponsor');
            
            // Search
            if (searchTerm) {
                bills = bills.filter(b => 
                    (b.title && b.title.toLowerCase().includes(searchTerm)) ||
                    (b.policy_area && b.policy_area.toLowerCase().includes(searchTerm)) ||
                    (b.bill_type && b.bill_number && `${b.bill_type}${b.bill_number}`.toLowerCase().includes(searchTerm))
                );
            }
            
            // Congress
            if (congressFilter) bills = bills.filter(b => b.congress == congressFilter);
            
            // Policy
            if (policyFilter) bills = bills.filter(b => (b.policy_area || 'Uncategorized') === policyFilter);
            
            // Sort
            bills.sort((a, b) => {
                if ((b.congress || 0) !== (a.congress || 0)) return (b.congress || 0) - (a.congress || 0);
                return (b.introduced_date || '').localeCompare(a.introduced_date || '');
            });
            
            filteredBills = bills;
            displayCount = 25;
            
            document.getElementById('results-count').textContent = `${bills.length} bills`;
            renderBills();
            updateInsights();
        }
        
        function clearFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('congress-filter').value = '';
            document.getElementById('policy-filter').value = '';
            document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
            activeCard = null;
            updateDynamicStats();
            applyFilters();
        }
        
        function renderBills() {
            const container = document.getElementById('bills-container');
            const toShow = filteredBills.slice(0, displayCount);
            
            if (toShow.length === 0) {
                container.innerHTML = '<p class="no-results">No bills found matching your filters.</p>';
                document.getElementById('load-more-btn').style.display = 'none';
                return;
            }
            
            container.innerHTML = toShow.map(bill => {
                const statusClass = bill.status === 'Became Law' ? 'law' : bill.died_in_committee ? 'died' : bill.status && bill.status.includes('Passed') ? 'passed' : 'committee';
                const statusText = bill.died_in_committee ? '‚ö∞Ô∏è Died' : bill.status || 'Unknown';
                
                return `<div class="bill-card">
                    <div class="bill-header">
                        <span class="bill-number">${bill.bill_type || ''}${bill.bill_number || ''}</span>
                        <span class="bill-status ${statusClass}">${statusText}</span>
                    </div>
                    <div class="bill-title">${bill.title || 'Untitled'}</div>
                    <div class="bill-meta">
                        <span>üìÖ ${bill.introduced_date || 'Unknown'}</span>
                        <span>üèõÔ∏è ${bill.congress || '?'}th Congress</span>
                        ${bill.role === 'cosponsor' ? '<span>ü§ù Cosponsor</span>' : ''}
                        <a href="${bill.url || '#'}" target="_blank" class="bill-link">Congress.gov ‚Üí</a>
                    </div>
                    ${bill.policy_area ? `<span class="policy-tag">${bill.policy_area}</span>` : ''}
                </div>`;
            }).join('');
            
            document.getElementById('load-more-btn').style.display = displayCount < filteredBills.length ? 'block' : 'none';
        }
        
        function loadMore() {
            displayCount += 25;
            renderBills();
        }
        
        loadData();
    </script>
</body>
</html>

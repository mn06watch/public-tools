<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emmer Tweet Archive | MN-06 Watch</title>
    <meta name="description" content="Search Rep. Tom Emmer's complete tweet history. 14,000+ tweets from 2017-2026.">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        :root {
            --navy: #1e3a5f;
            --navy-dark: #152a45;
            --navy-light: #2a4a73;
            --gold: #d4a84b;
            --gold-light: #e4bc6b;
            --gold-dark: #b8923f;
            --bg-dark: #0d1117;
            --bg-card: #151c25;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --border: #2a3441;
            --twitter-blue: #1d9bf0;
            --red: #da3633;
            --red-light: #f85149;
            --green: #238636;
            --green-light: #2ea043;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        header {
            text-align: center;
            padding: 40px 0 30px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 30px;
        }
        
        .page-title { font-size: 2.5rem; font-weight: 800; color: #fff; margin-bottom: 8px; }
        .page-title span { color: var(--gold); }
        .page-subtitle { color: var(--text-secondary); font-size: 1.1rem; }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid var(--border);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .stat-card:hover { border-color: var(--navy-light); transform: translateY(-2px); }
        .stat-card.active { border-color: var(--gold); background: rgba(212, 168, 75, 0.1); }
        
        .stat-value { font-size: 1.8rem; font-weight: 700; color: var(--gold); line-height: 1; }
        .stat-value.twitter { color: var(--twitter-blue); }
        .stat-label { font-size: 0.8rem; color: var(--text-secondary); margin-top: 8px; }
        
        /* Insight Box */
        .highlight-box {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-dark) 100%);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid var(--navy-light);
        }
        
        .highlight-box h3 { color: var(--gold); margin-bottom: 15px; font-size: 1.2rem; }
        .highlight-box p { color: var(--text-secondary); margin-bottom: 10px; }
        .highlight-box .big-stat { font-size: 2.5rem; font-weight: 700; color: var(--twitter-blue); }
        
        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
        }
        
        .chart-title { font-size: 1.1rem; font-weight: 600; color: #fff; margin-bottom: 15px; }
        .chart-container { position: relative; height: 350px; }
        .chart-container.tall { height: 450px; }
        
        .chart-reset {
            position: absolute;
            bottom: 10px;
            right: 10px;
            padding: 5px 10px;
            background: var(--navy);
            color: var(--gold);
            border: 1px solid var(--navy-light);
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }
        
        .chart-card:hover .chart-reset { opacity: 1; }
        .chart-reset:hover { background: var(--navy-light); }
        
        /* Hot Topics */
        .hot-topics-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }
        
        .hot-topics-section h3 { color: var(--gold); margin-bottom: 15px; font-size: 1.1rem; }
        
        .hot-topic-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
            margin: 0 -10px;
            padding-left: 10px;
            padding-right: 10px;
            border-radius: 6px;
        }
        
        .hot-topic-item:hover { background: rgba(212, 168, 75, 0.1); }
        .hot-topic-item:last-child { border-bottom: none; }
        
        .hot-topic-name { color: var(--text-primary); font-weight: 500; }
        .hot-topic-trend { font-size: 0.85rem; padding: 2px 8px; border-radius: 10px; }
        .hot-topic-trend.up { background: rgba(34, 197, 94, 0.2); color: var(--green-light); }
        .hot-topic-trend.down { background: rgba(248, 81, 73, 0.2); color: var(--red-light); }
        
        /* Filter Bar */
        .filter-bar {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            background: var(--bg-dark);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
        }
        
        .search-input::placeholder { color: var(--text-secondary); }
        .search-input:focus { outline: none; border-color: var(--gold); }
        
        .filter-select {
            padding: 10px 12px;
            background: var(--bg-dark);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .filter-label { color: var(--text-secondary); font-size: 0.9rem; }
        
        .clear-filters-btn {
            padding: 10px 15px;
            background: var(--navy);
            color: var(--gold);
            border: 1px solid var(--navy-light);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .clear-filters-btn:hover { background: var(--navy-light); }
        .results-count { color: var(--text-secondary); font-size: 0.9rem; margin-left: auto; }
        
        /* Tweet Cards */
        .tweet-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            transition: border-color 0.2s;
        }
        
        .tweet-card:hover { border-color: var(--navy-light); }
        
        .tweet-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .tweet-account {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .account-badge {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .account-badge.rep { background: rgba(29, 155, 240, 0.2); color: var(--twitter-blue); }
        .account-badge.whip { background: rgba(212, 168, 75, 0.2); color: var(--gold); }
        .account-badge.personal { background: rgba(139, 148, 158, 0.2); color: var(--text-secondary); }
        
        .tweet-date { color: var(--text-secondary); font-size: 0.85rem; }
        
        .tweet-text {
            color: var(--text-primary);
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 12px;
            white-space: pre-wrap;
        }
        
        .tweet-topics {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }
        
        .topic-tag {
            padding: 3px 10px;
            background: var(--navy-dark);
            color: var(--text-secondary);
            border-radius: 10px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .topic-tag:hover { background: var(--navy-light); color: var(--gold); }
        
        .tweet-link {
            color: var(--twitter-blue);
            text-decoration: none;
            font-size: 0.85rem;
        }
        
        .tweet-link:hover { text-decoration: underline; }
        
        .load-more {
            display: block;
            width: 100%;
            padding: 15px;
            background: var(--navy);
            color: #fff;
            border: 1px solid var(--navy-light);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
            margin-top: 20px;
        }
        
        .load-more:hover { background: var(--navy-light); }
        .no-results { text-align: center; padding: 40px; color: var(--text-secondary); }
        
        footer {
            text-align: center;
            padding: 40px 20px;
            border-top: 1px solid var(--border);
            margin-top: 40px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        footer a { color: var(--gold); text-decoration: none; }
        footer a:hover { text-decoration: underline; }
        
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
            .charts-grid { grid-template-columns: 1fr; }
            .filter-bar { flex-direction: column; align-items: stretch; }
            .results-count { margin-left: 0; text-align: center; }
        }
    </style>
</head>
<body>
    <div id="mn06-nav"></div>
    
    <div class="container">
        <header>
            <h1 class="page-title">Tweet <span>Archive</span></h1>
            <p class="page-subtitle">14,000+ tweets from Rep. Tom Emmer (2017-2026)</p>
        </header>
        
        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card" onclick="filterByCard('all')" id="card-all">
                <div class="stat-value" id="total-tweets">--</div>
                <div class="stat-label">Total Tweets</div>
            </div>
            <div class="stat-card" onclick="filterByCard('RepTomEmmer')" id="card-RepTomEmmer">
                <div class="stat-value twitter" id="count-rep">--</div>
                <div class="stat-label">@RepTomEmmer</div>
            </div>
            <div class="stat-card" onclick="filterByCard('GOPMajorityWhip')" id="card-GOPMajorityWhip">
                <div class="stat-value" id="count-whip">--</div>
                <div class="stat-label">@GOPMajorityWhip</div>
            </div>
            <div class="stat-card" onclick="filterByCard('tomemmer')" id="card-tomemmer">
                <div class="stat-value" id="count-personal">--</div>
                <div class="stat-label">@tomemmer</div>
            </div>
            <div class="stat-card" id="card-daterange">
                <div class="stat-value" style="font-size: 1.3rem;" id="date-range">--</div>
                <div class="stat-label">Date Range</div>
            </div>
        </div>
        
        <!-- Dynamic Insight Box -->
        <div class="highlight-box">
            <h3 id="insight-title">ðŸ“Š The Archive</h3>
            <div id="insight-content"><p>Loading...</p></div>
        </div>
        
        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-title">ðŸ“‚ Top Topics</div>
                <div class="chart-container tall">
                    <canvas id="topics-chart"></canvas>
                    <button class="chart-reset" onclick="document.getElementById('topic-filter').value=''; applyFilters();">Reset Filter</button>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-title">ðŸ“ˆ Tweets Over Time</div>
                <div class="chart-container">
                    <canvas id="timeline-chart"></canvas>
                    <button class="chart-reset" onclick="document.getElementById('year-filter').value=''; applyFilters();">Reset Filter</button>
                </div>
            </div>
        </div>
        
        <!-- Hot Topics -->
        <div class="hot-topics-section">
            <h3>ðŸ”¥ Trending Topics (Last 90 Days vs Historical)</h3>
            <div id="hot-topics-list">Loading...</div>
        </div>
        
        <!-- Filters -->
        <div class="filter-bar">
            <input type="text" class="search-input" id="search-input" placeholder="Search tweets..." oninput="applyFilters()">
            <span class="filter-label">Topic:</span>
            <select class="filter-select" id="topic-filter" onchange="applyFilters()">
                <option value="">All Topics</option>
            </select>
            <span class="filter-label">Year:</span>
            <select class="filter-select" id="year-filter" onchange="applyFilters()">
                <option value="">All Years</option>
            </select>
            <button class="clear-filters-btn" onclick="clearFilters()">Clear Filters</button>
            <span class="results-count" id="results-count">-- tweets</span>
        </div>
        
        <!-- Tweets List -->
        <div id="tweets-container"><p class="no-results">Loading...</p></div>
        <button class="load-more" id="load-more-btn" onclick="loadMore()" style="display: none;">Load More Tweets</button>
        
        <footer>
            <p>Archive updated <span id="last-updated">--</span>. Direct links to original tweets.</p>
            <p style="margin-top: 8px;"><a href="/">Vote Tracker</a> Â· <a href="/sponsorships/">Bills</a> Â· <a href="/transcripts/">Transcripts</a></p>
            <p style="margin-top: 10px;">Â© 2025 MN-06 Watch. Independent accountability journalism.</p>
        </footer>
    </div>
    
    <script src="/nav.js"></script>
    <script>
        let allTweets = [];
        let filteredTweets = [];
        let activeCard = null;
        let displayCount = 25;
        let charts = {};
        let topicCounts = {};
        
        async function loadData() {
            try {
                const response = await fetch('https://pub-19f43b48149546699964c5a800800a2f.r2.dev/tweets_data.json');
                const data = await response.json();
                allTweets = data.tweets || data || [];
                
                // Sort by date descending
                allTweets.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                updateStats();
                buildTopicCounts();
                populateFilters();
                createCharts();
                findHotTopics();
                applyFilters();
                
                // Last updated
                if (allTweets.length > 0) {
                    const latest = new Date(allTweets[0].created_at);
                    document.getElementById('last-updated').textContent = latest.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('tweets-container').innerHTML = '<p class="no-results">Error loading data.</p>';
            }
        }
        
        function updateStats() {
            const byAccount = {};
            allTweets.forEach(t => {
                const acct = t.source_handle || 'unknown';
                byAccount[acct] = (byAccount[acct] || 0) + 1;
            });
            
            document.getElementById('total-tweets').textContent = allTweets.length.toLocaleString();
            document.getElementById('count-rep').textContent = (byAccount['RepTomEmmer'] || 0).toLocaleString();
            document.getElementById('count-whip').textContent = (byAccount['GOPMajorityWhip'] || 0).toLocaleString();
            document.getElementById('count-personal').textContent = (byAccount['tomemmer'] || 0).toLocaleString();
            
            // Date range
            if (allTweets.length > 0) {
                const dates = allTweets.map(t => new Date(t.created_at)).filter(d => !isNaN(d));
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                document.getElementById('date-range').textContent = `${minDate.getFullYear()} - ${maxDate.getFullYear()}`;
            }
        }
        
        function buildTopicCounts() {
            topicCounts = {};
            allTweets.forEach(t => {
                const topics = t.topics_canonical || t.topics || [];
                topics.forEach(topic => {
                    topicCounts[topic] = (topicCounts[topic] || 0) + 1;
                });
            });
        }
        
        function populateFilters() {
            // Topics
            const topicSelect = document.getElementById('topic-filter');
            Object.entries(topicCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 50)
                .forEach(([topic, count]) => {
                    const option = document.createElement('option');
                    option.value = topic;
                    option.textContent = `${topic} (${count})`;
                    topicSelect.appendChild(option);
                });
            
            // Years
            const years = new Set();
            allTweets.forEach(t => {
                const year = new Date(t.created_at).getFullYear();
                if (!isNaN(year)) years.add(year);
            });
            
            const yearSelect = document.getElementById('year-filter');
            [...years].sort((a, b) => b - a).forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
        }
        
        function createCharts() {
            createTopicsChart();
            createTimelineChart();
        }
        
        function createTopicsChart() {
            const ctx = document.getElementById('topics-chart');
            const sorted = Object.entries(topicCounts).sort((a, b) => b[1] - a[1]).slice(0, 20);
            
            charts.topics = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(([t]) => t.length > 25 ? t.substring(0, 25) + '...' : t),
                    datasets: [{
                        label: 'Tweets',
                        data: sorted.map(([_, c]) => c),
                        backgroundColor: 'rgba(29, 155, 240, 0.7)',
                        borderColor: '#1d9bf0',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: { ticks: { color: '#8b949e' }, grid: { color: '#2a3441' } },
                        y: { ticks: { color: '#e6edf3', font: { size: 11 } }, grid: { display: false } }
                    },
                    plugins: { legend: { display: false } },
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const topic = sorted[elements[0].index][0];
                            document.getElementById('topic-filter').value = topic;
                            applyFilters();
                        }
                    }
                }
            });
        }
        
        function createTimelineChart() {
            const ctx = document.getElementById('timeline-chart');
            
            // Group by month
            const monthly = {};
            allTweets.forEach(t => {
                const date = new Date(t.created_at);
                if (isNaN(date)) return;
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthly[key] = (monthly[key] || 0) + 1;
            });
            
            const sorted = Object.entries(monthly).sort((a, b) => a[0].localeCompare(b[0]));
            
            charts.timeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sorted.map(([m]) => m),
                    datasets: [{
                        label: 'Tweets',
                        data: sorted.map(([_, c]) => c),
                        borderColor: '#d4a84b',
                        backgroundColor: 'rgba(212, 168, 75, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { color: '#8b949e', maxTicksLimit: 12 }, grid: { color: '#2a3441' } },
                        y: { ticks: { color: '#8b949e' }, grid: { color: '#2a3441' } }
                    },
                    plugins: { legend: { display: false } },
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const month = sorted[elements[0].index][0];
                            const year = month.split('-')[0];
                            document.getElementById('year-filter').value = year;
                            applyFilters();
                        }
                    }
                }
            });
        }
        
        function findHotTopics() {
            const now = new Date();
            const cutoff90 = new Date(new Date().setDate(now.getDate() - 90));
            
            // Count tweets in recent 90 days vs previous period
            const recentCounts = {};
            const olderCounts = {};
            let totalRecent = 0;
            let totalOlder = 0;
            
            allTweets.forEach(t => {
                const date = new Date(t.created_at);
                const topics = t.topics_canonical || t.topics || [];
                
                topics.forEach(topic => {
                    if (date >= cutoff90) {
                        recentCounts[topic] = (recentCounts[topic] || 0) + 1;
                        totalRecent++;
                    } else {
                        olderCounts[topic] = (olderCounts[topic] || 0) + 1;
                        totalOlder++;
                    }
                });
            });
            
            // Calculate trends using share of voice (% of tweets) rather than raw counts
            const trends = [];
            Object.keys({...recentCounts, ...olderCounts}).forEach(topic => {
                const recent = recentCounts[topic] || 0;
                const older = olderCounts[topic] || 0;
                
                // Require minimum baseline: at least 20 historical mentions OR 10 recent
                if (older < 20 && recent < 10) return;
                
                // Calculate share of voice
                const recentShare = totalRecent > 0 ? (recent / totalRecent) * 100 : 0;
                const olderShare = totalOlder > 0 ? (older / totalOlder) * 100 : 0;
                
                // Change in share of voice (percentage points)
                const shareChange = recentShare - olderShare;
                
                // For display, show relative change but cap it
                let displayChange;
                if (olderShare > 0.1) {
                    displayChange = Math.min(((recentShare - olderShare) / olderShare) * 100, 500);
                } else if (recent >= 10) {
                    displayChange = 100; // New-ish topic with traction
                } else {
                    return;
                }
                
                trends.push({ 
                    topic, 
                    recent, 
                    older,
                    recentShare: recentShare.toFixed(1),
                    shareChange,
                    displayChange 
                });
            });
            
            // Sort by share change (actual shift in focus)
            const rising = trends.filter(t => t.shareChange > 0.5).sort((a, b) => b.shareChange - a.shareChange);
            const falling = trends.filter(t => t.shareChange < -0.5 && t.older >= 50).sort((a, b) => a.shareChange - b.shareChange);
            
            const container = document.getElementById('hot-topics-list');
            let html = '';
            
            rising.slice(0, 5).forEach(({ topic, recent, recentShare, displayChange }) => {
                const changeText = displayChange > 200 ? 'ðŸ”¥ Surging' : `â†‘ ${Math.round(displayChange)}%`;
                html += `<div class="hot-topic-item" onclick="filterByTopic('${topic.replace(/'/g, "\\'")}')">
                    <span class="hot-topic-name">${topic}</span>
                    <span class="hot-topic-trend up">${changeText} (${recent} recent, ${recentShare}% of tweets)</span>
                </div>`;
            });
            
            if (falling.length > 0) {
                html += '<div style="margin: 15px 0; color: var(--text-secondary); font-size: 0.85rem;">Topics declining:</div>';
                falling.slice(0, 3).forEach(({ topic, recent, older, shareChange }) => {
                    html += `<div class="hot-topic-item" onclick="filterByTopic('${topic.replace(/'/g, "\\'")}')">
                        <span class="hot-topic-name">${topic}</span>
                        <span class="hot-topic-trend down">â†“ ${Math.abs(shareChange).toFixed(1)}pp (was ${older}, now ${recent})</span>
                    </div>`;
                });
            }
            
            container.innerHTML = html || '<p style="color: var(--text-secondary);">Not enough data for trends.</p>';
        }
        
        function filterByTopic(topic) {
            document.getElementById('topic-filter').value = topic;
            applyFilters();
            document.getElementById('tweets-container').scrollIntoView({ behavior: 'smooth' });
        }
        
        function filterByCard(type) {
            document.getElementById('search-input').value = '';
            document.getElementById('topic-filter').value = '';
            document.getElementById('year-filter').value = '';
            document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
            
            if (activeCard === type) {
                activeCard = null;
            } else {
                activeCard = type;
                if (type !== 'all') {
                    document.getElementById(`card-${type}`).classList.add('active');
                }
            }
            
            applyFilters();
        }
        
        function updateInsights() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const topicFilter = document.getElementById('topic-filter').value;
            const yearFilter = document.getElementById('year-filter').value;
            
            const titleEl = document.getElementById('insight-title');
            const contentEl = document.getElementById('insight-content');
            
            let title = 'ðŸ“Š The Archive';
            let html = '';
            
            if (searchTerm) {
                title = `ðŸ” "${searchTerm}"`;
                const matches = allTweets.filter(t => t.text && t.text.toLowerCase().includes(searchTerm));
                html = `<p>Found <span class="big-stat">${matches.length.toLocaleString()}</span> tweets mentioning "${searchTerm}".</p>`;
                
                if (matches.length > 0) {
                    const years = {};
                    matches.forEach(t => {
                        const y = new Date(t.created_at).getFullYear();
                        if (!isNaN(y)) years[y] = (years[y] || 0) + 1;
                    });
                    const topYear = Object.entries(years).sort((a, b) => b[1] - a[1])[0];
                    if (topYear) {
                        html += `<p style="margin-top: 10px; font-size: 0.9rem;">Most active year: <strong>${topYear[0]}</strong> (${topYear[1]} tweets)</p>`;
                    }
                }
            }
            else if (topicFilter) {
                title = `ðŸ“‚ ${topicFilter}`;
                const topicTweets = allTweets.filter(t => (t.topics_canonical || t.topics || []).includes(topicFilter));
                const pct = ((topicTweets.length / allTweets.length) * 100).toFixed(1);
                
                html = `<p><span class="big-stat">${topicTweets.length.toLocaleString()}</span> tweets on this topic.</p>`;
                html += `<p style="margin-top: 10px;">${pct}% of Emmer's total Twitter output.</p>`;
                
                // Find peak year
                const years = {};
                topicTweets.forEach(t => {
                    const y = new Date(t.created_at).getFullYear();
                    if (!isNaN(y)) years[y] = (years[y] || 0) + 1;
                });
                const topYear = Object.entries(years).sort((a, b) => b[1] - a[1])[0];
                if (topYear) {
                    html += `<p style="font-size: 0.9rem;">Peak year: <strong>${topYear[0]}</strong> (${topYear[1]} tweets)</p>`;
                }
            }
            else if (yearFilter) {
                title = `ðŸ“… ${yearFilter}`;
                const yearTweets = allTweets.filter(t => new Date(t.created_at).getFullYear() == yearFilter);
                
                html = `<p>Emmer posted <span class="big-stat">${yearTweets.length.toLocaleString()}</span> tweets in ${yearFilter}.</p>`;
                
                // Top topics that year
                const yearTopics = {};
                yearTweets.forEach(t => {
                    (t.topics_canonical || t.topics || []).forEach(topic => {
                        yearTopics[topic] = (yearTopics[topic] || 0) + 1;
                    });
                });
                const topTopics = Object.entries(yearTopics).sort((a, b) => b[1] - a[1]).slice(0, 3);
                if (topTopics.length > 0) {
                    html += `<p style="margin-top: 10px; font-size: 0.9rem;">Top topics: ${topTopics.map(([t, c]) => `<strong>${t}</strong> (${c})`).join(', ')}</p>`;
                }
            }
            else if (activeCard && activeCard !== 'all') {
                const accountNames = {
                    'RepTomEmmer': '@RepTomEmmer (Official)',
                    'GOPMajorityWhip': '@GOPMajorityWhip (Leadership)',
                    'tomemmer': '@tomemmer (Personal)'
                };
                title = `ðŸ¦ ${accountNames[activeCard] || activeCard}`;
                
                const accountTweets = allTweets.filter(t => t.source_handle === activeCard);
                html = `<p><span class="big-stat">${accountTweets.length.toLocaleString()}</span> tweets from this account.</p>`;
                
                // Date range for this account
                const dates = accountTweets.map(t => new Date(t.created_at)).filter(d => !isNaN(d));
                if (dates.length > 0) {
                    const min = new Date(Math.min(...dates));
                    const max = new Date(Math.max(...dates));
                    html += `<p style="margin-top: 10px; font-size: 0.9rem;">Active: ${min.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })} â€“ ${max.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}</p>`;
                }
                
                if (activeCard === 'GOPMajorityWhip') {
                    html += `<p style="margin-top: 10px; font-size: 0.9rem;">This account is for his role as House Majority Whip (Jan 2023â€“present).</p>`;
                }
            }
            else {
                const avgPerDay = (allTweets.length / (365 * 9)).toFixed(1);
                html = `<p>Complete archive of Rep. Tom Emmer's tweets since 2017.</p>`;
                html += `<p style="margin-top: 10px;"><span class="big-stat">${allTweets.length.toLocaleString()}</span> total tweets across 3 accounts.</p>`;
                html += `<p style="margin-top: 10px; font-size: 0.9rem;">That's ~${avgPerDay} tweets per day for 9 years. Every statement searchable.</p>`;
            }
            
            titleEl.textContent = title;
            contentEl.innerHTML = html;
        }
        
        function applyFilters() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const topicFilter = document.getElementById('topic-filter').value;
            const yearFilter = document.getElementById('year-filter').value;
            
            let tweets = allTweets;
            
            // Account filter
            if (activeCard && activeCard !== 'all') {
                tweets = tweets.filter(t => t.source_handle === activeCard);
            }
            
            // Search
            if (searchTerm) {
                tweets = tweets.filter(t => t.text && t.text.toLowerCase().includes(searchTerm));
            }
            
            // Topic
            if (topicFilter) {
                tweets = tweets.filter(t => (t.topics_canonical || t.topics || []).includes(topicFilter));
            }
            
            // Year
            if (yearFilter) {
                tweets = tweets.filter(t => new Date(t.created_at).getFullYear() == yearFilter);
            }
            
            filteredTweets = tweets;
            displayCount = 25;
            
            document.getElementById('results-count').textContent = `${tweets.length.toLocaleString()} tweets`;
            renderTweets();
            updateInsights();
        }
        
        function clearFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('topic-filter').value = '';
            document.getElementById('year-filter').value = '';
            document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
            activeCard = null;
            applyFilters();
        }
        
        function renderTweets() {
            const container = document.getElementById('tweets-container');
            const toShow = filteredTweets.slice(0, displayCount);
            
            if (toShow.length === 0) {
                container.innerHTML = '<p class="no-results">No tweets found matching your filters.</p>';
                document.getElementById('load-more-btn').style.display = 'none';
                return;
            }
            
            container.innerHTML = toShow.map(tweet => {
                const date = new Date(tweet.created_at);
                const dateStr = !isNaN(date) ? date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Unknown';
                
                const accountClass = tweet.source_handle === 'RepTomEmmer' ? 'rep' : tweet.source_handle === 'GOPMajorityWhip' ? 'whip' : 'personal';
                const accountLabel = tweet.source_handle === 'RepTomEmmer' ? '@RepTomEmmer' : tweet.source_handle === 'GOPMajorityWhip' ? '@GOPMajorityWhip' : '@tomemmer';
                
                const topics = tweet.topics_canonical || tweet.topics || [];
                const topicsHtml = topics.slice(0, 5).map(t => 
                    `<span class="topic-tag" onclick="event.stopPropagation(); filterByTopic('${t.replace(/'/g, "\\'")}')">${t}</span>`
                ).join('');
                
                const tweetUrl = tweet.url || `https://x.com/${tweet.source_handle}/status/${tweet.id}`;
                
                return `<div class="tweet-card">
                    <div class="tweet-header">
                        <div class="tweet-account">
                            <span class="account-badge ${accountClass}">${accountLabel}</span>
                        </div>
                        <span class="tweet-date">${dateStr}</span>
                    </div>
                    <div class="tweet-text">${escapeHtml(tweet.text || '')}</div>
                    ${topicsHtml ? `<div class="tweet-topics">${topicsHtml}</div>` : ''}
                    <a href="${tweetUrl}" target="_blank" class="tweet-link">View on X â†’</a>
                </div>`;
            }).join('');
            
            document.getElementById('load-more-btn').style.display = displayCount < filteredTweets.length ? 'block' : 'none';
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function loadMore() {
            displayCount += 25;
            renderTweets();
        }
        
        loadData();
    </script>
</body>
</html>

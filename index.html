<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emmer Vote Tracker | MN-06 Watch</title>
    <meta name="description" content="Search Rep. Tom Emmer's complete voting record. 6,000+ votes from 2015-2025. Accountability journalism for Minnesota's 6th District.">
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        :root {
            --navy: #1e3a5f;
            --navy-dark: #152a45;
            --navy-light: #2a4a73;
            --gold: #d4a84b;
            --gold-light: #e4bc6b;
            --gold-dark: #b8923f;
            --bg-dark: #0d1117;
            --bg-card: #151c25;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --border: #2a3441;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        /* Top Navigation */
        .top-nav {
            background: var(--navy-dark);
            border-bottom: 1px solid var(--border);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            background: rgba(21, 42, 69, 0.95);
        }
        
        .nav-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: var(--gold);
            font-weight: 700;
            font-size: 1rem;
        }
        
        .nav-logo {
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }
        
        .nav-links {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .nav-link:hover {
            color: var(--text-primary);
            background: var(--navy);
        }
        
        .nav-link.active {
            color: var(--gold);
            font-weight: 600;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Dashboard */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .dashboard-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
        }
        
        .dashboard-card h3 {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }
        
        .big-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--gold);
        }
        
        .big-number-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .stats-row {
            display: flex;
            justify-content: space-around;
            text-align: center;
            margin-top: 15px;
        }
        
        .stat-item {
            flex: 1;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .topic-bars {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .topic-bar {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .topic-bar-label {
            width: 100px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: capitalize;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .topic-bar-track {
            flex: 1;
            height: 18px;
            background: var(--bg-dark);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .topic-bar-fill {
            height: 100%;
            background: var(--gold);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 6px;
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--navy-dark);
            min-width: 25px;
        }
        
        .loyalty-meter {
            margin-top: 10px;
        }
        
        .meter-track-loyalty {
            height: 24px;
            background: var(--bg-dark);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        
        .meter-fill-loyalty {
            height: 100%;
            background: linear-gradient(to right, var(--gold), #22c55e);
            border-radius: 6px;
            transition: width 0.3s ease;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .against-party-info {
            margin-top: 12px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .against-party-info span {
            color: var(--gold);
            font-weight: 600;
        }
        
        header {
            text-align: center;
            padding: 40px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 30px;
        }
        
        .logo-img {
            width: 120px;
            height: 120px;
            margin-bottom: 20px;
            border-radius: 50%;
        }
        
        .logo-text {
            font-size: 2.5rem;
            font-weight: 800;
            color: #fff;
            margin-bottom: 10px;
        }
        
        .logo-text span {
            color: var(--gold);
        }
        
        .tagline {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }
        
        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gold);
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .search-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-box input {
            flex: 1;
            padding: 15px 20px;
            font-size: 1.1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg-dark);
            color: #fff;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .search-box input:focus {
            border-color: var(--gold);
        }
        
        .search-box input::placeholder {
            color: var(--text-secondary);
        }
        
        .search-box button {
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            background: var(--gold);
            color: var(--navy-dark);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .search-box button:hover {
            background: var(--gold-light);
        }
        
        .filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .filter-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-right: 5px;
        }
        
        .filter-btn {
            padding: 8px 16px;
            font-size: 0.9rem;
            background: var(--navy-dark);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .filter-btn:hover {
            background: var(--navy);
            color: #fff;
        }
        
        .filter-btn.active {
            background: var(--gold);
            color: var(--navy-dark);
            border-color: var(--gold);
            font-weight: 600;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            color: var(--text-secondary);
        }
        
        .results-count {
            font-size: 0.95rem;
        }
        
        .sort-select {
            padding: 8px 12px;
            background: var(--bg-card);
            color: #fff;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
        }
        
        .vote-card {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid var(--border);
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid var(--border);
            border-left-width: 4px;
        }
        
        .vote-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .vote-card.yea {
            border-left-color: #22c55e;
        }
        
        .vote-card.nay {
            border-left-color: #ef4444;
        }
        
        .vote-card.missed {
            border-left-color: var(--gold);
        }
        
        .vote-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            gap: 15px;
        }
        
        .vote-bill {
            font-weight: 700;
            color: #fff;
            font-size: 1.1rem;
        }
        
        .vote-date {
            color: var(--text-secondary);
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        .vote-title {
            color: var(--text-secondary);
            margin-bottom: 12px;
            font-size: 0.95rem;
        }
        
        .vote-question {
            color: var(--gold);
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 12px;
            padding: 6px 10px;
            background: rgba(212, 168, 75, 0.1);
            border-radius: 4px;
            display: inline-block;
        }
        
        .vote-meta {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .vote-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-yea {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        
        .badge-nay {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .badge-missed {
            background: rgba(212, 168, 75, 0.2);
            color: var(--gold);
        }
        
        .badge-against {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
        }
        
        .badge-mn {
            background: rgba(30, 58, 95, 0.5);
            color: var(--gold-light);
            border: 1px solid var(--navy-light);
        }
        
        .topic-tag {
            padding: 3px 10px;
            background: var(--navy-dark);
            color: var(--text-secondary);
            border-radius: 10px;
            font-size: 0.75rem;
        }
        
        .vote-summary {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 0.9rem;
            display: none;
        }
        
        .vote-card.expanded .vote-summary {
            display: block;
        }
        
        .expand-btn {
            background: none;
            border: none;
            color: var(--gold);
            cursor: pointer;
            font-size: 0.85rem;
            padding: 0;
            margin-top: 10px;
        }
        
        .expand-btn:hover {
            text-decoration: underline;
        }
        
        .load-more {
            display: block;
            width: 100%;
            padding: 15px;
            margin-top: 20px;
            background: var(--navy);
            color: #fff;
            border: 1px solid var(--navy-light);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
        }
        
        .load-more:hover {
            background: var(--navy-light);
        }
        
        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .no-results h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: var(--text-primary);
        }
        
        .cta-box {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-dark) 100%);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin: 40px 0;
            border: 1px solid var(--navy-light);
        }
        
        .cta-box h3 {
            font-size: 1.4rem;
            margin-bottom: 10px;
            color: #fff;
        }
        
        .cta-box p {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }
        
        .cta-btn {
            display: inline-block;
            padding: 12px 30px;
            background: var(--gold);
            color: var(--navy-dark);
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: background 0.2s;
        }
        
        .cta-btn:hover {
            background: var(--gold-light);
        }
        
        footer {
            text-align: center;
            padding: 40px 0;
            border-top: 1px solid var(--border);
            margin-top: 40px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        footer a {
            color: var(--gold);
            text-decoration: none;
        }
        
        footer a:hover {
            text-decoration: underline;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid var(--border);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 600px) {
            .search-box {
                flex-direction: column;
            }
            
            .stats-bar {
                gap: 20px;
            }
            
            .stat-number {
                font-size: 1.5rem;
            }
            
            .vote-header {
                flex-direction: column;
                gap: 5px;
            }
            
            .filters {
                justify-content: center;
            }
            
            .logo-img {
                width: 100px;
                height: 100px;
            }
            
            .logo-text {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Nav injected by nav.js -->
    <div id="mn06-nav"></div>

    <div class="container">
        <header>
            <img src="MN06Watch_Logo.png" alt="MN-06 Watch Logo" class="logo-img">
            <div class="logo-text">MN-06 <span>Watch</span></div>
            <div class="tagline">Receipts, Not Rage. Tracking Rep. Tom Emmer's Voting Record.</div>
        </header>
        
        <div class="dashboard">
            <div class="dashboard-card">
                <h3>Filtered Results</h3>
                <div class="big-number" id="total-votes">--</div>
                <div class="big-number-label">Votes Shown</div>
                <div class="stats-row">
                    <div class="stat-item">
                        <div class="stat-value" id="yea-count">--</div>
                        <div class="stat-label">Yea</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="nay-count">--</div>
                        <div class="stat-label">Nay</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="missed-votes">--</div>
                        <div class="stat-label">Missed</div>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-card">
                <h3>Top Policy Areas</h3>
                <div class="topic-bars" id="topic-bars">
                    <!-- Filled by JS -->
                </div>
            </div>
            
            <div class="dashboard-card">
                <h3>Party Loyalty</h3>
                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 10px;">
                    <span id="loyalty-pct">--</span> voted with party
                </p>
                <div class="loyalty-meter">
                    <div class="meter-track-loyalty">
                        <div class="meter-fill-loyalty" id="loyalty-fill" style="width: 95%;"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Independent</span>
                        <span>Party Line</span>
                    </div>
                </div>
                <div class="against-party-info" id="against-party-info">
                    <span id="against-party">--</span> votes against party in current results
                </div>
            </div>
        </div>
        
        <div class="search-section">
            <div class="search-box">
                <input type="text" id="search-input" placeholder="Search votes... (e.g., veterans, healthcare, border)">
                <button onclick="performSearch()">Search</button>
            </div>
            <div class="filters">
                <span class="filter-label">Vote type:</span>
                <button class="filter-btn active" data-filter="vote" data-value="all">All</button>
                <button class="filter-btn" data-filter="vote" data-value="yea">Yea</button>
                <button class="filter-btn" data-filter="vote" data-value="nay">Nay</button>
                <button class="filter-btn" data-filter="vote" data-value="missed">Missed</button>
            </div>
            <div class="filters">
                <span class="filter-label">Tags:</span>
                <button class="filter-btn toggle-btn" data-filter="against">Against Party</button>
                <button class="filter-btn toggle-btn" data-filter="mn">MN Relevant</button>
                <button class="filter-btn toggle-btn" data-filter="passage">Passage Votes Only</button>
            </div>
        </div>
        
        <div class="results-header">
            <div class="results-count" id="results-count">Loading...</div>
            <select class="sort-select" id="sort-select" onchange="performSearch()">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
            </select>
        </div>
        
        <div id="results">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading voting record...</p>
            </div>
        </div>
        
        <button class="load-more" id="load-more" style="display: none;" onclick="loadMore()">
            Load More Results
        </button>
        
        <div class="cta-box">
            <h3>Want Deeper Analysis?</h3>
            <p>Get weekly reports, contradiction alerts, and exclusive deep dives on Emmer's record.</p>
            <a href="https://mn06watch.substack.com/subscribe" class="cta-btn">Subscribe to MN-06 Watch</a>
        </div>
        
        <footer>
            <p>Data sourced from official House roll call votes (2015-2025)</p>
            <p>An <a href="https://mn06watch.substack.com">MN-06 Watch</a> accountability project</p>
            <p style="margin-top: 8px;"><a href="https://mn06watch.com/tweets/">Tweet Archive</a> · <a href="https://mn06watch.com/transcripts/">Transcripts</a> · <a href="https://mn06watch.substack.com/subscribe">Subscribe</a></p>
            <p style="margin-top: 10px;">© 2025 MN-06 Watch. Independent accountability journalism.</p>
            <p style="margin-top: 8px; font-size: 0.8rem; color: #666;">Vote data last updated: January 30, 2026</p>
        </footer>
    </div>
    
    <script>
        let allVotes = [];
        let filteredVotes = [];
        let displayedCount = 0;
        const BATCH_SIZE = 25;
        let currentVoteFilter = 'all';
        let activeToggles = new Set(); // No default filters - show all votes
        
        // Procedural vote types to filter out
        const PROCEDURAL_QUESTIONS = [
            'On Motion to Recommit',
            'On Agreeing to the Amendment',
            'On Motion to Suspend the Rules and Pass',
            'On Ordering the Previous Question',
            'On Motion to Commit with Instructions',
            'Table Motion to Refer',
            'On Approving the Journal',
            'Election of the Speaker',
            'Call by States',
            'On Agreeing to the Resolution'
        ];
        
        function isPassageVote(vote) {
            const question = vote.question || '';
            // Include "On Passage" and exclude procedural votes
            if (question === 'On Passage') return true;
            if (PROCEDURAL_QUESTIONS.some(pq => question.includes(pq))) return false;
            // Include other substantive votes
            return !question.includes('Amendment') && !question.includes('Recommit') && !question.includes('Journal');
        }
        
        // Load data
        async function loadData() {
            try {
                const response = await fetch('https://pub-19f43b48149546699964c5a800800a2f.r2.dev/votes_data.json');
                allVotes = await response.json();
                performSearch();
            } catch (error) {
                document.getElementById('results').innerHTML = `
                    <div class="no-results">
                        <h3>Error Loading Data</h3>
                        <p>Please try refreshing the page.</p>
                    </div>
                `;
            }
        }
        
        function updateDashboard(votes) {
            // Basic counts
            document.getElementById('total-votes').textContent = votes.length.toLocaleString();
            
            const yeaCount = votes.filter(v => ['Yea', 'Aye', 'Yes'].includes(v.vote)).length;
            const nayCount = votes.filter(v => ['Nay', 'No'].includes(v.vote)).length;
            const missedCount = votes.filter(v => v.missed).length;
            const againstCount = votes.filter(v => v.against_party).length;
            
            document.getElementById('yea-count').textContent = yeaCount.toLocaleString();
            document.getElementById('nay-count').textContent = nayCount.toLocaleString();
            document.getElementById('missed-votes').textContent = missedCount.toLocaleString();
            document.getElementById('against-party').textContent = againstCount.toLocaleString();
            
            // Party loyalty calculation
            const nonMissedVotes = votes.filter(v => !v.missed).length;
            const loyaltyPct = nonMissedVotes > 0 ? ((nonMissedVotes - againstCount) / nonMissedVotes * 100) : 0;
            document.getElementById('loyalty-pct').textContent = loyaltyPct.toFixed(1) + '%';
            document.getElementById('loyalty-fill').style.width = loyaltyPct + '%';
            
            // Policy area breakdown
            const policyCounts = {};
            votes.forEach(v => {
                const area = v.policy_area || 'Other';
                policyCounts[area] = (policyCounts[area] || 0) + 1;
            });
            
            const sortedPolicies = Object.entries(policyCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const maxCount = sortedPolicies[0] ? sortedPolicies[0][1] : 1;
            
            const topicBars = document.getElementById('topic-bars');
            if (sortedPolicies.length === 0) {
                topicBars.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.85rem;">No policy areas in current results</p>';
            } else {
                topicBars.innerHTML = sortedPolicies.map(([policy, count]) => {
                    const pct = (count / maxCount) * 100;
                    return `
                        <div class="topic-bar">
                            <span class="topic-bar-label">${policy}</span>
                            <div class="topic-bar-track">
                                <div class="topic-bar-fill" style="width: ${pct}%">${count}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        // Common suffixes to strip for stemmed search
        const SUFFIXES = ['ing', 'tion', 'sion', 'ment', 'ness', 'ity', 'ous', 'ive', 'ians', 'ian', 'ans', 'ers', 'ies', 'ia', 'es', 'ed', 'ly', 'an', 's'];
        
        // Get search stems from a query
        function getSearchStems(query) {
            const terms = new Set([query]); // Use Set to avoid duplicates
            const lower = query.toLowerCase();
            
            // Try removing common suffixes to get root
            for (const suffix of SUFFIXES) {
                if (lower.endsWith(suffix) && lower.length > suffix.length + 2) {
                    const stem = lower.slice(0, -suffix.length);
                    if (stem.length >= 3) {
                        terms.add(stem);
                    }
                }
            }
            
            // For each term we have, also add common variations
            const baseTerms = [...terms];
            for (const term of baseTerms) {
                // Add 's' plural
                terms.add(term + 's');
                
                // If ends in 'i', try 'ia', 'ian', 'ians' (Somali -> Somalia, Somalian)
                if (term.endsWith('i')) {
                    terms.add(term + 'a');
                    terms.add(term + 'an');
                    terms.add(term + 'ans');
                }
                
                // If ends in 'a', try 'an', 'ans', stripping 'a' for 'i' form
                if (term.endsWith('a')) {
                    terms.add(term + 'n');
                    terms.add(term + 'ns');
                    terms.add(term.slice(0, -1) + 'i');
                    terms.add(term.slice(0, -1) + 'ian');
                    terms.add(term.slice(0, -1) + 'ians');
                }
                
                // If ends in 'y', try 'ies'
                if (term.endsWith('y')) {
                    terms.add(term.slice(0, -1) + 'ies');
                }
                
                // Common verb forms
                terms.add(term + 'ing');
                terms.add(term + 'ed');
            }
            
            return [...terms];
        }
        
        function performSearch() {
            const query = document.getElementById('search-input').value.toLowerCase().trim();
            const sortOrder = document.getElementById('sort-select').value;
            
            // Filter votes
            filteredVotes = allVotes.filter(vote => {
                // Apply vote type filter
                if (currentVoteFilter === 'yea' && !['Yea', 'Aye', 'Yes'].includes(vote.vote)) return false;
                if (currentVoteFilter === 'nay' && !['Nay', 'No'].includes(vote.vote)) return false;
                if (currentVoteFilter === 'missed' && !vote.missed) return false;
                
                // Apply toggle filters (AND logic - must match all active toggles)
                if (activeToggles.has('against') && !vote.against_party) return false;
                if (activeToggles.has('mn') && !vote.mn_relevant) return false;
                if (activeToggles.has('passage') && !isPassageVote(vote)) return false;
                
                // Apply search query
                if (query) {
                    const searchText = [
                        vote.bill,
                        vote.title,
                        vote.description,
                        vote.policy_area,
                        vote.summary,
                        ...vote.topics
                    ].filter(Boolean).join(' ').toLowerCase();
                    
                    // Get word stems to search for
                    const searchTerms = getSearchStems(query);
                    
                    // Check if any stem matches
                    return searchTerms.some(term => searchText.includes(term));
                }
                
                return true;
            });
            
            // Sort
            if (sortOrder === 'oldest') {
                filteredVotes.sort((a, b) => a.year - b.year);
            } else {
                filteredVotes.sort((a, b) => b.year - a.year);
            }
            
            // Reset and display
            displayedCount = 0;
            document.getElementById('results').innerHTML = '';
            
            // Update dashboard with filtered results
            updateDashboard(filteredVotes);
            
            loadMore();
            
            // Update count
            document.getElementById('results-count').textContent = 
                `${filteredVotes.length.toLocaleString()} votes found`;
        }
        
        function loadMore() {
            const container = document.getElementById('results');
            const end = Math.min(displayedCount + BATCH_SIZE, filteredVotes.length);
            
            for (let i = displayedCount; i < end; i++) {
                container.appendChild(createVoteCard(filteredVotes[i]));
            }
            
            displayedCount = end;
            
            // Toggle load more button
            const loadMoreBtn = document.getElementById('load-more');
            if (displayedCount >= filteredVotes.length) {
                loadMoreBtn.style.display = 'none';
            } else {
                loadMoreBtn.style.display = 'block';
                loadMoreBtn.textContent = `Load More (${filteredVotes.length - displayedCount} remaining)`;
            }
            
            // Show no results message
            if (filteredVotes.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <h3>No votes found</h3>
                        <p>Try a different search term or filter.</p>
                    </div>
                `;
            }
        }
        
        function createVoteCard(vote) {
            const card = document.createElement('div');
            
            let voteClass = '';
            let badgeClass = '';
            let badgeText = vote.vote;
            
            if (vote.missed) {
                voteClass = 'missed';
                badgeClass = 'badge-missed';
                badgeText = 'MISSED';
            } else if (['Yea', 'Aye', 'Yes'].includes(vote.vote)) {
                voteClass = 'yea';
                badgeClass = 'badge-yea';
            } else if (['Nay', 'No'].includes(vote.vote)) {
                voteClass = 'nay';
                badgeClass = 'badge-nay';
            }
            
            card.className = `vote-card ${voteClass}`;
            
            let badges = `<span class="vote-badge ${badgeClass}">${badgeText}</span>`;
            if (vote.against_party) {
                badges += `<span class="vote-badge badge-against">Against Party</span>`;
            }
            if (vote.mn_relevant) {
                badges += `<span class="vote-badge badge-mn">MN Relevant</span>`;
            }
            
            let topics = vote.topics.map(t => `<span class="topic-tag">${t}</span>`).join('');
            
            let summarySection = '';
            if (vote.summary) {
                summarySection = `
                    <button class="expand-btn" onclick="toggleSummary(this)">Show bill summary</button>
                    <div class="vote-summary">${vote.summary}</div>
                `;
            }
            
            // Show vote question if it's not a simple passage vote
            let questionLine = '';
            const q = (vote.question || '').toLowerCase();
            if (q && !q.includes('on passage') && !q.includes('on agreeing to the resolution')) {
                questionLine = `<div class="vote-question">Vote: ${vote.question}</div>`;
            }
            
            card.innerHTML = `
                <div class="vote-header">
                    <span class="vote-bill">${vote.bill || 'Procedural Vote'}</span>
                    <span class="vote-date">${vote.date}</span>
                </div>
                <div class="vote-title">${vote.title || vote.description || 'No description available'}</div>
                ${questionLine}
                <div class="vote-meta">
                    ${badges}
                    ${topics}
                </div>
                ${summarySection}
            `;
            
            return card;
        }
        
        function toggleSummary(btn) {
            const card = btn.closest('.vote-card');
            card.classList.toggle('expanded');
            btn.textContent = card.classList.contains('expanded') ? 'Hide summary' : 'Show bill summary';
        }
        
        // Vote type filter buttons (single select)
        document.querySelectorAll('.filter-btn[data-filter="vote"]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn[data-filter="vote"]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentVoteFilter = btn.dataset.value;
                performSearch();
            });
        });
        
        // Toggle filter buttons (multi-select)
        document.querySelectorAll('.filter-btn.toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const filter = btn.dataset.filter;
                if (activeToggles.has(filter)) {
                    activeToggles.delete(filter);
                    btn.classList.remove('active');
                } else {
                    activeToggles.add(filter);
                    btn.classList.add('active');
                }
                performSearch();
            });
        });
        
        // Search on enter
        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch();
        });
        
        // Load data on page load
        loadData();
    </script>
    <script src="/nav.js"></script>
</body>
</html>
